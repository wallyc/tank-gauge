-module(tank). 
-author('wally.cash@gmail.com').
-compile(export_all).
-export([]).
-import(lists, [nth/2]).
-include("gauge.hrl"). 

%%
%% get gallons
%%

get_gallons(G, {X}, _, _) ->
	{ok, round(G * X)} ;

get_gallons(G, {X, _Y, Z}, C, side) when G =< length(X), C == 0 ->
	{ok, get_gal(G, X, Z)} ;

get_gallons(G, {X, _Y, _Z}, C, side) when G =< length(X), G =< C ->
	{ok, get_gal(G, X)} ;

get_gallons(G, {X, _Y, Z}, C, side) when G =< length(X), G > C ->
	{ok, get_gal(G, X, Z)} ;

get_gallons(G, {_X, Y, _Z}, _, center) ->
	io:format("four"),
	G2 = (trunc(G) * 8) + (((G - trunc(G)) * 16) / 2),
	case G2 =< length(Y) of
		true ->
			{ok, get_gal(G2, Y)};
		_ ->
			get_gallons([],[],[],[])
	end;

get_gallons(_, _, _, _) -> 
	{error, "Gauge out of strapping range"}.

%%
%% get gallons using chart with fraction table.
%%

get_gal(G, I, F) ->
	case G-trunc(G) > 0 of
		true ->
			(nth(trunc(G) + 1, I)) + nth(round(((G - trunc(G)) / ?SIXTEENTH)), F);
		_ ->
			(nth(trunc(G) + 1, I))
	end.

%%
%% get gallons using chart without fraction table.
%%

get_gal(G, I) ->
	round(interpolate((nth(trunc(G) + 1, I)), (nth(trunc(G) + 2, I)), G)).

%%
%% get gallons using Gpi.
%%

get_gallons_gpi(G, Gpi) ->
	(trunc(G) * Gpi) + round((G - trunc(G)) * Gpi).

%%
%% interpolate between two numbers.
%%

interpolate(L, H, V) ->
  	(V-trunc(V)) * (H - L) + L.

%%
%% get tank height
%% 

get_height(M, side) ->
	M#tank.side;
get_height(M, center) ->
	M#tank.center.

%%
%% get tank metrics
%% 

get_tank(T) -> 
	db:select_tank(T).

%%
%% init tank metrics
%% 

init_metrics() ->
		[
		{tank, 10, 485.25, 552.0, 440.0, 2, 0, true, seven, "PG 70-22", 5.0},
		{tank, 20, 490.5, undefined, 440.0, 0, 0, true, seven, "PG 76-22", 6.0},
		{tank, 30, 299.875, undefined, 263.875, 0, 0, true, seven, "CRS-2L", 8.5},
		{tank, 40, 276.0, undefined, 246.0, 0, 0, false, sixb, "#2 Fuel Oil", 32.2}].

%%
%% gpi strappings
%%

get_strap(30) -> {190.5};
get_strap(40) -> {55.75};

%%
%% tabular strappings {[side],[center],[fraction]}
%%

get_strap(10) ->
{[41600,43200,44800,46400,48000,49600,51200,52800,54400,
56000,57600,59200,60800,62400,64000,65600,67200,68800,
70400, 72000,73600,75200,76800,78400,80000,81600,83200,
84800,86400,88000,89600,91200,92800,94400, 96000,97600,
99200,100800,102400,104000,105600,107200,108800,110400,
112000,113600,115200,116800,118400,120000,121600,123200,
124800,126400,128000,129600,131200,132800,134400,136000,
137600,139200,140800,142400,144000,145600,147200,148800,
150400,152000,153600,155200,156800,158400,160000,161600,
163200,164800,166400,168000,169600,171200,172800,174400,
176000,177600,179200,180800,182400,184000,185600,187200,
188800,190400,192000,193600,195200,196800,198400,200000,
201600,203200,204800,206400,208000,209600,211200,212800,
214400,216000,217600,219200,220800,222400,224000,225600,
227200,228800,230400,232000,233600,235200,236800,238400,
240000,241600,243200,244800,246400,248000,249600,251200,
252800,254400,256000,257600,259200,260800,262400,264000,
265600,267200,268800,270400,272000,273600,275200,276800,
278400,280000,281600,283200,284800,286400,288000,289600,
291200,292800,294400,296000,297600,299200,300800,302400,
304000,305600,307200,308800,310400,312000,313600,315200,
316800,318400,320000,321600,323200,324800,326400,328000,
329600,331200,332800,334400,336000,337600,339200,340800,
342400,344000,345600,347200,348800,350400,352000,353600,
355200,356800,358400,360000,361600,363200,364800,366400,
368000,369600,371200,372800,374400,376000,377600,379200,
380800,382400,384000,385600,387200,388800,390400,392000,
393600,395200,396800,398400,400000,401600,403200,404800,
406400,408000,409600,411200,412800,414400,416000,417600,
419200,420800,422400,424000,425600,427200,428800,430400,
432000,433600,435200,436800,438400,440000,441600,443200,
444800,446400,448000,449600,451200,452800,454400,456000,
457600,459200,460800,462400,464000,465600,467200,468800,
470400,472000,473600,475200,476800,478400,480000,481600,
483200,484800,486400,488000,489600,491200,492800,494400,
496000,497600,499200,500800,502400,504000,505600,507200,
508800,510400,512000,513600,515200,516800,518400,520000,
521600,523200,524800,526400,528000,529600,531200,532800,
534400,536000,537600,539200,540800,542400,544000,545600,
547200,548800,550400,552000,553600,555200,556800,558400,
560000,561600,563200,564800,566400,568000,569600,571200,
572800,574400,576000,577600,579200,580800,582400,584000,
585600,587200,588800,590400,592000,593600,595200,596800,
598400,600000,601600,603200,604800,606400,608000,609600,
11200,612800,614400,616000,617600,619200,620800,622400,
624000,625600,627200,628800,630400,632000,633600,635200,
636800,638400,640000,641600,643200,644800,646400,648000,
649600,651200,652800,654400,656000,657600,659200,660800,
662400,664000,665600,667200,668800,670400,672000,673600,
675200,676800,678400,680000,681600,683200,684800,686400,
688000,689600,691200,692800,694400,696000,697600,699200,
700800,702400,704000,705600,707200,708800,710400,712000,
713600,715200,716800,718400,720000,721600,723200,724800,
726400,728000,729600,731200,732800,734400,736000,737600,
739200,740800,742400,744000,745600,747200,748800,750400,
752000,753600],
[0,419,837,1256,1675,2093,2512,2931,3349,3768,4187,4605,
5024,5443,5861,6280,6699,7117,7536,7955,8373,8792,9211,
9629, 10048,10467,10885,11304,11723,12141,12560,12979,
13397,13816,14235, 14653,15072,15491,15909,16328,16747,
17165,17584,18003,18421, 18840,19259,19677,20096,20515,
20933,21352,21771,22189,22608,23027,23445,23864,24283,
24701, 25120,25539,25957,26376,26795,27213,27632,28051,
28469,28888, 29307,29725,30144,30563,30981,31400,31819,
32237,32656,33075,33493,33912,34331,34749,35168, 35587,
36005,36424,36843,37261,37680,38099,38517,38936,39355,
39773,40192,40611,41029],
[100,200,300,400,500,600,
700,800,900,1000,1100,1200,1300,1400,1500]};

get_strap(20) ->
{[1600,3200,4800,6400,8000,9600,11200,12800,
14400,16000,17600,19200,20800,22400,24000,25600,
27200,28800,30400,32000,33600,35200,36800,38400,40000,
41600,43200,44800,46400,48000,49600,51200,52800,54400,
56000,57600,59200,60800,62400,64000,65600,67200,68800,
70400, 72000,73600,75200,76800,78400,80000,81600,83200,
84800,86400,88000,89600,91200,92800,94400, 96000,97600,
99200,100800,102400,104000,105600,107200,108800,110400,
112000,113600,115200,116800,118400,120000,121600,123200,
124800,126400,128000,129600,131200,132800,134400,136000,
137600,139200,140800,142400,144000,145600,147200,148800,
150400,152000,153600,155200,156800,158400,160000,161600,
163200,164800,166400,168000,169600,171200,172800,174400,
176000,177600,179200,180800,182400,184000,185600,187200,
188800,190400,192000,193600,195200,196800,198400,200000,
201600,203200,204800,206400,208000,209600,211200,212800,
214400,216000,217600,219200,220800,222400,224000,225600,
227200,228800,230400,232000,233600,235200,236800,238400,
240000,241600,243200,244800,246400,248000,249600,251200,
252800,254400,256000,257600,259200,260800,262400,264000,
265600,267200,268800,270400,272000,273600,275200,276800,
278400,280000,281600,283200,284800,286400,288000,289600,
291200,292800,294400,296000,297600,299200,300800,302400,
304000,305600,307200,308800,310400,312000,313600,315200,
316800,318400,320000,321600,323200,324800,326400,328000,
329600,331200,332800,334400,336000,337600,339200,340800,
342400,344000,345600,347200,348800,350400,352000,353600,
355200,356800,358400,360000,361600,363200,364800,366400,
368000,369600,371200,372800,374400,376000,377600,379200,
380800,382400,384000,385600,387200,388800,390400,392000,
393600,395200,396800,398400,400000,401600,403200,404800,
406400,408000,409600,411200,412800,414400,416000,417600,
419200,420800,422400,424000,425600,427200,428800,430400,
432000,433600,435200,436800,438400,440000,441600,443200,
444800,446400,448000,449600,451200,452800,454400,456000,
457600,459200,460800,462400,464000,465600,467200,468800,
470400,472000,473600,475200,476800,478400,480000,481600,
483200,484800,486400,488000,489600,491200,492800,494400,
496000,497600,499200,500800,502400,504000,505600,507200,
508800,510400,512000,513600,515200,516800,518400,520000,
521600,523200,524800,526400,528000,529600,531200,532800,
534400,536000,537600,539200,540800,542400,544000,545600,
547200,548800,550400,552000,553600,555200,556800,558400,
560000,561600,563200,564800,566400,568000,569600,571200,
572800,574400,576000,577600,579200,580800,582400,584000,
585600,587200,588800,590400,592000,593600,595200,596800,
598400,600000,601600,603200,604800,606400,608000,609600,
11200,612800,614400,616000,617600,619200,620800,622400,
624000,625600,627200,628800,630400,632000,633600,635200,
636800,638400,640000,641600,643200,644800,646400,648000,
649600,651200,652800,654400,656000,657600,659200,660800,
662400,664000,665600,667200,668800,670400,672000,673600,
675200,676800,678400,680000,681600,683200,684800,686400,
688000,689600,691200,692800,694400,696000,697600,699200,
700800,702400,704000,705600,707200,708800,710400,712000],
[],
[100,200,300,400,500,600,700,800,900,1000,1100,1200,1300,
1400,1500]}.
