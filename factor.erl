-module(factor). 
-author('wally.cash@gmail.com').
-compile(export_all).
-export([]).
-import(lists, [nth/2]).

%%
%% get correction factors 
%%

get_factors(Grav, Temp, Table) ->
	{get_scf(Temp), get_vcf(Temp, Grav, Table)}.

get_factors(Grav, Temp, Ambient, Table) ->
	{get_scf(Temp, Ambient), get_vcf(Temp, Grav, Table)}.

%%
%% table name - atom -> string 
%%
factor_to_text(sixb) -> "6b"; 
factor_to_text(seven) -> "7".

%%
%% compute shell correction factor 
%%

get_scf(Temp, Ambient) ->
	K2=(Temp*0.875 + 0.125 * Ambient)-60,
	roundit(1 + (0.0000124 * K2) + (0.0000062 * 0.0000062 * K2 * K2), 5).

get_scf(Temp) ->
	K2=Temp-60,
	roundit(1 + (0.0000124 * K2) + (0.0000062 * 0.0000062 * K2 * K2), 5).

%%
%% compute volume correction factor (indirection)
%%

get_vcf(Temp, Grav, sixb) ->	vcf6b(Grav, Temp);
get_vcf(Temp, Grav, seven) ->	vcf7(Grav, Temp).

%%
%% compute table 6b vcf
%%

vcf6b(Grav, Temp) ->
	R0=(((141.5 * 999.012)/(Grav + 131.5)) + 0.005),
	A=(103.872/R0)/R0,
	B=0.2701/R0,
	AL=(A + B),
	D=Temp-60.0,
	E1=AL*D,
	E2=(0.8*(AL * AL)) * (D * D),
	E3=-E1-E2,
	C=math:exp(E3),
	roundit(C, 5).

%%
%% round a float to a specified precision
%%

roundit(N, Pr) ->
  	P=math:pow(10, Pr),
 	round(N * P) / P.


%%
%% get table 7 vcf 
%%

vcf7(_Grav, Temp) when is_number(Temp)-> 
	lists:nth(trunc(Temp + 1), table7()).


%%
%% table low API range <15.0 factors - need to get algorithm vs storing table 
%%

table7() ->
[1.0211,1.0208,1.0204,1.0201,1.0197,1.0194,1.0190,1.0186,1.0183,1.0179,1.0176,1.0172,1.0169,1.0165,
1.0162,1.0158,1.0155,1.0151,1.0148,1.0144,1.0141,1.0137,1.0133,1.0130,1.0126,1.0123,1.0119,1.0116,
1.0112,1.0109,1.0105,1.0102,1.0098,1.0095,1.0091,1.0088,1.0084,1.0081,1.0077,1.0074,1.0070,1.0067,
1.0063,1.0060,1.0056,1.0053,1.0049,1.0046,1.0042,1.0038,1.0035,1.0031,1.0028,1.0024,1.0021,1.0017,
1.0014,1.0010,1.0007,1.0003,1.0000,0.9997,0.9993,0.9990,0.9986,0.9983,0.9979,0.9976,0.9972,0.9969,
0.9965,0.9962,0.9958,0.9955,0.9951,0.9948,0.9944,0.9941,0.9937,0.9934,0.9930,0.9927,0.9923,0.9920,
0.9916,0.9913,0.9909,0.9906,0.9902,0.9899,0.9896,0.9892,0.9889,0.9885,0.9882,0.9878,0.9875,0.9871,
0.9868,0.9864,0.9861,0.9857,0.9854,0.9851,0.9847,0.9844,0.9840,0.9837,0.9833,0.9830,0.9826,0.9823,
0.9819,0.9816,0.9813,0.9809,0.9806,0.9802,0.9799,0.9795,0.9792,0.9788,0.9875,0.9782,0.9778,0.9775,
0.9771,0.9768,0.9764,0.9761,0.9758,0.9754,0.9751,0.9747,0.9744,0.9740,0.9737,0.9734,0.9730,0.9727,
0.9723,0.9720,0.9716,0.9713,0.9710,0.9706,0.9706,0.9699,0.9696,0.9693,0.9689,0.9686,0.9682,0.9679,
0.9675,0.9672,0.9669,0.9665,0.9662,0.9658,0.9655,0.9652,0.9648,0.9645,0.9641,0.9638,0.9635,0.9631,
0.9628,0.9624,0.9621,0.9618,0.9614,0.9611,0.9607,0.9604,0.9601,0.9597,0.9594,0.9590,0.9587,0.9584,
0.9580,0.9577,0.9574,0.9570,0.9567,0.9563,0.9560,0.9557,0.9553,0.9550,0.9547,0.9543,0.9540,0.9536,
0.9533,0.9530,0.9526,0.9523,0.9520,0.9516,0.9513,0.9509,0.9506,0.9503,0.9499,0.9496,0.9493,0.9489,
0.9486,0.9483,0.9479,0.9476,0.9472,0.9469,0.9466,0.9462,0.9459,0.9456,0.9452,0.9449,0.9446,0.9442,
0.9439,0.9436,0.9432,0.9429,0.9426,0.9422,0.9419,0.9416,0.9412,0.9409,0.9405,0.9402,0.9399,0.9395,
0.9392,0.9389,0.9385,0.9382,0.9379,0.9375,0.9372,0.9369,0.9365,0.9362,0.9359,0.9356,0.9352,0.9349,
0.9346,0.9342,0.9339,0.9336,0.9332,0.9329,0.9326,0.9322,0.9319,0.9316,0.9312,0.9309,0.9306,0.9302,
0.9299,0.9296,0.9293,0.9289,0.9286,0.9283,0.9279,0.9276,0.9273,0.9269,0.9266,0.9263,0.9259,0.9256,
0.9256,0.9250,0.9246,0.9243,0.9240,0.9236,0.9233,0.9230,0.9227,0.9223,0.9220,0.9217,0.9213,0.9210,
0.9207,0.9204,0.9200,0.9197,0.9194,0.9190,0.9187,0.9184,0.9181,0.9177,0.9174,0.9171,0.9167,0.9164,
0.9161,0.9158,0.9154,0.9151,0.9148,0.9145,0.9141,0.9138,0.9135,0.9132,0.9128,0.9125,0.9122,0.9118,
0.9115,0.9112,0.9109,0.9105,0.9102,0.9099,0.9096,0.9092,0.9089,0.9086,0.9083,0.9079,0.9076,0.9073,
0.9070,0.9066,0.9063,0.9060,0.9057,0.9053,0.9050,0.9047,0.9044,0.9040,0.9037,0.9034,0.9031,0.9028,
0.9024,0.9021,0.9018,0.9015,0.9011,0.9008,0.9005,0.9002,0.8998,0.8995,0.8992,0.8989,0.8986,0.8982,
0.8979,0.8976,0.8973,0.8969,0.8966,0.8963,0.8960,0.8957,0.8953,0.8950,0.8947,0.8944,0.8941,0.8937,
0.8937,0.8931,0.8928,0.8924,0.8921,0.8918,0.8915,0.8912,0.8909,0.8905,0.8902,0.8899,0.8896,0.8892,
0.8889,0.8886,0.8883,0.8880,0.8876,0.8873,0.8870,0.8867,0.8864,0.8861,0.8857,0.8854,0.8851,0.8848,
0.8845,0.8841,0.8838,0.8835,0.8832,0.8829,0.8826,0.8822,0.8819,0.8816,0.8813,0.8810,0.8806,0.8803,
0.8800,0.8797,0.8794,0.8791,0.8787,0.8758,0.8781,0.8778,0.8775,0.8772,0.8768,0.8765,0.8762,0.8759,
0.8756,0.8753,0.8749,0.8746,0.8743,0.8740,0.8737,0.8734,0.8731,0.8727,0.8724,0.8721,0.8718,0.8715,
0.8712,0.8709,0.8705,0.8702,0.8699,0.8696,0.8693,0.8690,0.8687,0.8683,0.8680,0.8677,0.8674,0.8671,
0.8668,0.8665,0.8661,0.8658,0.8655,0.8652,0.8649,0.8646,0.8643,0.8640,0.8636,0.8633,0.8630,0.8627,
0.8624,0.8621,0.8618,0.8615,0.8611,0.8608,0.8605,0.8602,0.8599,0.8596,0.8593,0.8590,0.8587,0.8583,
0.8580,0.8577,0.8574,0.8571,0.8568,0.8565,0.8562,0.8559,0.8556,0.8552,0.8549].
